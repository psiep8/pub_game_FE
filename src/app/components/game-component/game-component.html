<div class="game-container">

  @if (phase() === 'IDLE' || (round()?.status === 'REVEAL' && !isSpinning())) {
    <div class="central-action" [class.full-screen]="phase() === 'IDLE'">
      <button (click)="startNewRound()" class="extract-btn">
        <span class="icon">{{ phase() === 'IDLE' ? 'üöÄ' : 'üé≤' }}</span>
        {{ phase() === 'IDLE' ? 'GIOCA ORA' : 'PROSSIMO ROUND' }}
      </button>
    </div>
  }

  @if (showTypeReveal()) {
    <div class="type-reveal-overlay" @fadeInOut>
      <div class="label">MODALIT√Ä ESTRATTA:</div>
      <div class="mode-name">{{ showTypeReveal() }}</div>
    </div>
  }

  <div class="bubbles-area">
    @for (cat of allCategories(); track cat.id; let i = $index) {
      <div class="category-bubble"
           [style.top]="cat.top"
           [style.left]="cat.left"
           [class.spinning]="phase() === 'SPINNING'"
           [class.is-selected]="selectedCatIndex() === i && phase() === 'SELECTED'"
           [class.as-title]="selectedCatIndex() === i && showQuestion()"
           [class.hidden]="showTypeReveal() || phase() === 'IDLE' || (selectedCatIndex() !== null && selectedCatIndex() !== i)">
        {{ cat.name }}
      </div>
    }
  </div>

  @if (showQuestion() && round(); as current) {
    <div class="question-area" @fadeInOut>
      <div class="timer-wrapper">
        <div class="timer-bar" [style.width.%]="current.status === 'REVEAL' ? 0 : timer() * 10"></div>
        <span class="timer-text">{{ current.status === 'REVEAL' ? 'Tempo Scaduto!' : timer() + 's' }}</span>
      </div>
      <h2 class="question-text">
        {{ current.payload?.question }}
      </h2>
      @if (current.payload?.options && current.type !== 'CHRONO' && current.payload.options.length > 0) {
        <div class="options-grid"
             [class.layout-quiz]="current.type === 'QUIZ' || current.type === 'TRUE_FALSE'">
          @for (opt of current.payload.options; track opt) {
            <button
              class="option-btn"
              [disabled]="current.status === 'REVEAL'"
              [class.correct]="
    current.status === 'REVEAL' &&
    opt === current.payload.correctAnswer
  "
            >
              {{ opt }}
            </button>
          }
        </div>
      }

      @if (current.type === 'CHRONO') {
        <div class="chrono-display">
          @if (current.status !== 'REVEAL') {
            <div class="chrono-waiting-box">
              <h3 class="chrono-title">INDIVIDUA L'ANNO!</h3>
              <div class="chrono-placeholder">‚ùì Scegli sul telefono... ‚ùì</div>
            </div>
          } @else {
            <div class="reveal-banner chrono-reveal" @fadeInOut>
              <div class="reveal-label">ANNO ESATTO:</div>
              <div class="reveal-value-big">{{ current.payload.correctAnswer }}</div>
            </div>
          }
        </div>
      }

      @if (current.status === 'REVEAL' && current.type !== 'CHRONO') {
        <div class="reveal-banner" @fadeInOut>
          <div class="reveal-label">RISPOSTA ESATTA:</div>
          <div class="reveal-value">{{ current.payload.correctAnswer }}</div>
        </div>
      }
    </div>

    <div class="live-feed-container">
      <div class="feed-header">RISPOSTE RICEVUTE</div>
      <div class="feed-list">
        @for (res of ws.responses(); track res.playerName) {
          <div class="feed-item" @fadeInOut>
            <span class="player-name">{{ res.playerName }}</span>
            <span class="player-time">{{ (res.responseTimeMs / 1000).toFixed(2) }}s</span>
          </div>
        }
      </div>
    </div>
  }

  <div class="controls-footer">
    <button (click)="openResetModal()" class="control-btn reset">üîÑ RESET</button>
    <button (click)="togglePause()" class="control-btn pause" [class.is-paused]="isPaused()">
      {{ isPaused() ? '‚ñ∂Ô∏è RIPRENDI' : '‚è∏Ô∏è PAUSA' }}
    </button>
  </div>

  @if (showResetModal()) {
    <div class="modal-overlay" @fadeInOut>
      <div class="modal-content">
        <h3>üö® RESET PARTITA</h3>
        <p>Sei sicuro di voler ricominciare?</p>
        <div class="modal-actions">
          <button class="modal-btn confirm" (click)="confirmReset()">S√å, RESETTA</button>
          <button class="modal-btn cancel" (click)="showResetModal.set(false)">ANNULLA</button>
        </div>
      </div>
    </div>
  }

  @if (isPaused()) {
    <div class="pause-overlay" @fadeInOut>
      <div class="pause-card"><h2>GIOCO IN PAUSA</h2>
        <button (click)="togglePause()" class="extract-btn">RIPRENDI</button>
      </div>
    </div>
  }
</div>
