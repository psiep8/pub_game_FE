<div class="game-container">

  <!-- SCHERMATA INIZIALE CON QR CODE -->
  @if (phase() === 'IDLE' || (round()?.status === 'REVEAL' && !isSpinning())) {
    <div class="central-action" [class.full-screen]="phase() === 'IDLE'">
      @if (phase() === 'IDLE') {
        <div class="qr-section">
          <h3>üì± SCANSIONA PER GIOCARE</h3>
          <img [src]="qrCodeUrl" alt="QR Code per giocare" class="qr-code">
          <p>Apri la camera e inquadra il QR</p>
        </div>
      }
      <button (click)="startNewRound()" class="extract-btn">
        <span class="icon">{{ phase() === 'IDLE' ? 'üöÄ' : 'üé≤' }}</span>
        {{ phase() === 'IDLE' ? 'GIOCA ORA' : 'PROSSIMO ROUND' }}
      </button>
    </div>
  }

  <!-- MODALIT√Ä ESTRATTA -->
  @if (showTypeReveal()) {
    <div class="type-reveal-overlay" @fadeInOut>
      <div class="label">MODALIT√Ä ESTRATTA:</div>
      <div class="mode-name">{{ showTypeReveal() }}</div>
    </div>
  }

  <!-- BOLLE CATEGORIE -->
  <div class="bubbles-area">
    @for (cat of allCategories(); track cat.id; let i = $index) {
      <div class="category-bubble"
           [style.top]="cat.top"
           [style.left]="cat.left"
           [style.--float-duration]="cat.duration"
           [style.--float-delay]="cat.delay"
           [class.spinning]="phase() === 'SPINNING'"
           [class.is-selected]="selectedCatIndex() === i && phase() === 'SELECTED'"
           [class.as-title]="selectedCatIndex() === i && showQuestion()"
           [class.hidden]="showTypeReveal() || phase() === 'IDLE' || (selectedCatIndex() !== null && selectedCatIndex() !== i)">
        {{ cat.name }}
      </div>
    }
  </div>

  <!-- AREA DOMANDA -->
  @if (showQuestion() && round(); as current) {
    <div class="question-area" @fadeInOut>
      <!-- TIMER -->
      <div class="timer-wrapper">
        <div class="timer-bar" [style.width.%]="current.status === 'REVEAL' ? 0 : timer() * 10"></div>
        <span class="timer-text">{{ current.status === 'REVEAL' ? 'Tempo Scaduto!' : timer() + 's' }}</span>
      </div>

      <!-- DOMANDA -->
      <h2 class="question-text">
        {{ current.payload.question }}
      </h2>

      <!-- OPZIONI (QUIZ / TRUE_FALSE) -->
      @if (current.payload.options && current.type !== 'CHRONO' && current.payload.options.length > 0) {
        <div class="options-grid"
             [class.layout-quiz]="current.type === 'QUIZ' || current.type === 'TRUE_FALSE'">
          @for (opt of current.payload.options; track opt) {
            <button
              class="option-btn"
              [disabled]="current.status === 'REVEAL'"
              [class.correct]="current.status === 'REVEAL' && opt === current.payload.correctAnswer">
              {{ opt }}
            </button>
          }
        </div>
      }

      <!-- CHRONO -->
      @if (current.type === 'CHRONO') {
        <div class="chrono-display">
          @if (current.status !== 'REVEAL') {
            <div class="chrono-waiting-box">
              <h3 class="chrono-title">INDIVIDUA L'ANNO!</h3>
              <div class="chrono-placeholder">‚ùì Scegli sul telefono... ‚ùì</div>
            </div>
          } @else {
            <div class="reveal-banner chrono-reveal" @fadeInOut>
              <div class="reveal-label">ANNO ESATTO:</div>
              <div class="reveal-value-big">{{ current.payload.correctAnswer }}</div>
            </div>
          }
        </div>
      }

      @if (showQuestion() && round()?.type === 'IMAGE_BLUR') {

        <h1 class="blur-title">RICONOSCI LA CELEBRIT√Ä?</h1>

        <div class="blur-main-container">
          <div class="image-wrapper">
            <img [src]="round()?.payload?.imageUrl"
                 [style.filter]="'blur(' + currentBlur + 'px)'"
                 class="blur-img">

            @if (playerWhoBuzzed) {
              <div class="buzz-announcement" @fadeInOut>
                <div class="player-highlight">{{ playerWhoBuzzed }}</div>
                <p>RISPONDI ORA!</p>
              </div>
            }
          </div>

          <div class="timer-dot-container">
            <div class="timer-value">{{ timer() }}s</div>
          </div>
        </div>

        <div class="mini-feed">
          @if (playerWhoBuzzed) {
            <span>Prenotazione attiva!</span>
          }
        </div>
      }

      <!-- REVEAL RISPOSTA -->
      @if (current.status === 'REVEAL' && current.type !== 'CHRONO') {
        <div class="reveal-banner" @fadeInOut>
          <div class="reveal-label">RISPOSTA ESATTA:</div>
          <div class="reveal-value">{{ current.payload.correctAnswer }}</div>
        </div>
      }
    </div>

    <!-- LIVE FEED RISPOSTE -->
    <div class="live-feed-container">
      <div class="feed-header">RISPOSTE RICEVUTE</div>
      <div class="feed-list">
        @for (res of ws.responses(); track res.playerName) {
          <div class="feed-item" @fadeInOut
               [class.chrono-item]="round()?.type === 'CHRONO'">

            <div class="player-info">
              <span class="player-name">{{ res.playerName }}</span>
              <span class="player-time">‚è±Ô∏è {{ (res.responseTimeMs / 1000).toFixed(2) }}s</span>
            </div>

            @if (round()?.type === 'CHRONO' && round()?.status === 'REVEAL') {
              <div class="chrono-details" @fadeInOut>
            <span class="distance-badge">
              ÂÅèÂ∑Æ: {{ getYearDistance(res.answerIndex) }} anni
            </span>
                <span class="guessed-year">Scelto: {{ res.answerIndex }}</span>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }

  <!-- CONTROLLI FOOTER -->
  <div class="controls-footer">
    <button (click)="openResetModal()" class="control-btn reset">üîÑ RESET</button>
    <button (click)="togglePause()" class="control-btn pause" [class.is-paused]="isPaused()">
      {{ isPaused() ? '‚ñ∂Ô∏è RIPRENDI' : '‚è∏Ô∏è PAUSA' }}
    </button>
  </div>

  <!-- MODAL RESET -->
  @if (showResetModal()) {
    <div class="modal-overlay" @fadeInOut>
      <div class="modal-content">
        <h3>üö® RESET PARTITA</h3>
        <p>Sei sicuro di voler ricominciare?</p>
        <div class="modal-actions">
          <button class="modal-btn confirm" (click)="confirmReset()">S√å, RESETTA</button>
          <button class="modal-btn cancel" (click)="showResetModal.set(false)">ANNULLA</button>
        </div>
      </div>
    </div>
  }

  <!-- OVERLAY PAUSA -->
  @if (isPaused()) {
    <div class="pause-overlay" @fadeInOut>
      <div class="pause-card">
        <h2>‚è∏Ô∏è GIOCO IN PAUSA</h2>
        <button (click)="togglePause()" class="extract-btn">
          <span class="icon">‚ñ∂Ô∏è</span>
          RIPRENDI
        </button>
      </div>
    </div>
  }

</div>
