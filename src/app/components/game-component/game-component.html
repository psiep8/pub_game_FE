<div class="game-container">

  <!-- SCHERMATA INIZIALE CON QR CODE -->
  @if (phase() === 'IDLE') {
    <div class="central-action full-screen">
      <div class="qr-section">
        <h3>üì± SCANSIONA PER GIOCARE</h3>
        <img [src]="qrCodeUrl" alt="QR Code per giocare" class="qr-code">
        <p>Apri la camera e inquadra il QR</p>
      </div>
      <button (click)="startNewRound()" class="extract-btn">
        <span class="icon">üöÄ</span>
        GIOCA ORA
      </button>
    </div>
  }

  <!-- MODALIT√Ä ESTRATTA -->
  @if (showTypeReveal()) {
    <div class="type-reveal-overlay">
      <div class="label">MODALIT√Ä ESTRATTA:</div>
      <div class="mode-name">{{ showTypeReveal() }}</div>
    </div>
  }

  <!-- BOLLE CATEGORIE -->
  @if (currentMode(); as mode) {
    @if (mode.requiresBubbles && !showTypeReveal() && phase() !== 'IDLE') {
      <div class="bubbles-area">
        @for (cat of allCategories(); track cat.id; let i = $index) {
          <div class="category-bubble"
               [style.top]="cat.top"
               [style.left]="cat.left"
               [class.spinning]="phase() === 'SPINNING'"
               [class.is-selected]="
  (animatedCategoryId() ?? selectedCategoryId()) === cat.id &&
  phase() === 'SELECTED'
"

               [class.as-title]="
  cat.id === selectedCategoryId() && showQuestion()
"

               [class.hidden]="
  selectedCategoryId() !== null &&
  cat.id !== (animatedCategoryId() ?? selectedCategoryId()) &&
  phase() !== 'SPINNING'
"
          >
            {{ cat.name }}
          </div>
        }
      </div>
    }
  }

  <!-- AREA DOMANDA CON DISPLAY DINAMICO -->
  @if (showQuestion() && currentMode(); as mode) {
    <div class="question-area" [class.no-padding]="!mode.requiresBubbles">

      <!-- TIMER BAR (solo per modalit√† con bolle) -->
      @if (mode.requiresBubbles) {
        <div class="timer-wrapper">
          <div class="timer-bar" [style.width.%]="(timer() / mode.timerDuration) * 100"></div>
          <span class="timer-text">{{ timer() }}s</span>
        </div>
      }

      <!-- DISPLAY COMPONENTS DINAMICI -->
      @switch (mode.type) {

        @case ('QUIZ') {
          <app-quiz
            [displayData]="mode.getDisplayData()"
            [timer]="timer()" />
        }

        @case ('TRUE_FALSE') {
          <app-true-false
            [displayData]="mode.getDisplayData()"
            [timer]="timer()" />
        }

        @case ('CHRONO') {
          <app-chrono
            [displayData]="mode.getDisplayData()"
            [timer]="timer()" />
        }

        @case ('IMAGE_BLUR') {
          <app-image-blur
            [displayData]="mode.getDisplayData()"
            [timer]="timer()"
            (onConfirmCorrect)="confirmCorrect()"
            (onConfirmWrong)="confirmWrong()" />
        }

        @case ('WHEEL_OF_FORTUNE') {
          <app-wheel-fortune
            [displayData]="mode.getDisplayData()"
            [timer]="timer()"
            (onConfirmCorrect)="confirmCorrect()"
            (onConfirmWrong)="confirmWrong()" />
        }

      }
    </div>

    <!-- LIVE FEED RISPOSTE (solo per modalit√† senza buzz) -->
    @if (!mode.requiresBuzz) {
      <div class="live-feed-container">
        <div class="feed-header">RISPOSTE RICEVUTE</div>
        <div class="feed-list">
          @for (res of ws.responses(); track res.playerName) {
            <div class="feed-item">
              <div class="player-info">
                <span class="player-name">{{ res.playerName }}</span>
                <span class="player-time">‚è±Ô∏è {{ (res.responseTimeMs / 1000).toFixed(2) }}s</span>
              </div>
            </div>
          }
        </div>
      </div>
    }
  }

  <!-- POPUP RISULTATO -->
  @if (showResultPopup()) {
    <div class="result-popup"
         [class.correct]="resultType() === 'correct'"
         [class.wrong]="resultType() === 'wrong'">
      <div class="result-icon">
        {{ resultType() === 'correct' ? '‚úÖ' : '‚ùå' }}
      </div>
      <div class="result-title">
        {{ resultType() === 'correct' ? 'RISPOSTA CORRETTA!' : 'RISPOSTA ERRATA!' }}
      </div>
      <div class="result-player">{{ resultPlayerName() }}</div>
      <div class="result-points">
        {{ resultPoints() > 0 ? '+' : '' }}{{ resultPoints() }} punti
      </div>
    </div>
  }

  <!-- CONTROLLI FOOTER -->
  <div class="controls-footer">
    <button (click)="openResetModal()" class="control-btn reset">üîÑ RESET</button>
    <button (click)="togglePause()" class="control-btn pause" [class.is-paused]="isPaused()">
      {{ isPaused() ? '‚ñ∂Ô∏è RIPRENDI' : '‚è∏Ô∏è PAUSA' }}
    </button>
  </div>

  <!-- MODAL RESET -->
  @if (showResetModal()) {
    <div class="modal-overlay">
      <div class="modal-content">
        <h3>üö® RESET PARTITA</h3>
        <p>Sei sicuro di voler ricominciare?</p>
        <div class="modal-actions">
          <button class="modal-btn confirm" (click)="confirmReset()">S√å, RESETTA</button>
          <button class="modal-btn cancel" (click)="showResetModal.set(false)">ANNULLA</button>
        </div>
      </div>
    </div>
  }

  <!-- OVERLAY PAUSA -->
  @if (isPaused()) {
    <div class="pause-overlay">
      <div class="pause-card">
        <h2>‚è∏Ô∏è GIOCO IN PAUSA</h2>
        <button (click)="togglePause()" class="extract-btn">
          <span class="icon">‚ñ∂Ô∏è</span>
          RIPRENDI
        </button>
      </div>
    </div>
  }

  <!-- PROSSIMO ROUND BUTTON (dopo reveal) -->
  @if (round()?.status === 'REVEAL' && !isSpinning()) {
    <div class="central-action">
      <button (click)="startNewRound()" class="extract-btn">
        <span class="icon">üé≤</span>
        PROSSIMO ROUND
      </button>
    </div>
  }

</div>

@if (currentMode(); as mode) {
  @if (mode.type === 'QUIZ' && mode.getShowGo?.()) {
    <div class="go-popup">üö¶ VIA!</div>
  }
}
